<?xml version="1.0"?>
<component name="fr.toutatice.ecm.platform.web.local.publishing.actions">

	<require>org.nuxeo.ecm.platform.actions.ActionService</require>
	<require>fr.toutatice.ecm.platform.web.local.publishing.filters</require>
	<require>fr.toutatice.ecm.platform.web.local.publishing.widgets</require>

	<extension target="org.nuxeo.ecm.platform.actions.ActionService"
		point="actions">

		<!-- Création et mise en ligne d'un document n'exigeant pas d'action de sauvegarde spécifique
			(pas de workflow de demande)
		-->
		<action id="CREATE_AND_SET_ONLINE_DOCUMENT" link="#{documentActions.saveNSetOnLineDocument}"
			order="0" label="command.create.and.setonline">
			<category>CREATE_DOCUMENT_FORM</category>
			<filter-id>is_not_creating_form_specific_document</filter-id>
			<filter-id>belong_to_publish_space</filter-id>
			<filter-id>not_proxy</filter-id>
			<filter-id>not_version</filter-id>
			<filter-id>filter@updateNSetDocumentOnline</filter-id>
			<filter id="filter@CREATE_AND_SET_ONLINE_DOCUMENT">
				<rule grant="true">
					<permission>validationWorkflow_validation</permission>
				</rule>
			</filter>
			<filter-id>ABSTRACT_FILTER@INNER_PUBLICATION_FEATURE</filter-id>			
		</action>

		<!-- Édition et mise en ligne d'un document n'exigeant pas d'action de sauvegarde spécifique
			(pas de workflow de demande) 
		-->
		<action id="EDIT_AND_SET_ONLINE_CURRENT_DOCUMENT" link="#{documentActions.updateNSetOnLineCurrentDocument}"
			order="1" label="command.save.and.setonline">
			<category>EDIT_DOCUMENT_FORM</category>
			<filter-id>is_not_thread_document</filter-id>
			<filter-id>belong_to_publish_space</filter-id>
			<filter-id>not_proxy</filter-id>
			<filter-id>not_version</filter-id>
			<filter-id>filter@updateNSetDocumentOnline</filter-id>
			<filter id="filter@EDIT_AND_SET_ONLINE_CURRENT_DOCUMENT">
				<rule grant="true">
					<permission>validationWorkflow_validation</permission>
				</rule>
			</filter>
			<filter-id>ABSTRACT_FILTER@INNER_PUBLICATION_FEATURE</filter-id>			
		</action>

		<!-- Vue 'Résumé': mise en ligne directe -->
		<action id="setDocumentOnlineDirect" label="command.direct.setonline"
			enabled="true" order="10" immediate="false"
			link="#{operationActionBean.doOperation('setOnLine')}">
			<category>SUMMARY_PANEL_TOP</category>
			<category>SUBVIEW_UPPER_LIST</category>
			<filter-id>belong_to_publish_space</filter-id>
			<filter-id>not_proxy</filter-id>
			<filter-id>not_version</filter-id>
			<filter-id>filter@setDocumentOnline</filter-id>
			<filter-id>ABSTRACT_FILTER@INNER_PUBLICATION_FEATURE</filter-id>
		</action>

		<!-- Vue 'Résumé': mise hors ligne directe -->
		<action id="setDocumentOfflineDirect" label="command.direct.setoffline"
			enabled="true" order="10" immediate="false"
			link="#{operationActionBean.doOperation('setOffLineOne')}">
			<category>SUMMARY_PANEL_TOP</category>
			<category>SUBVIEW_UPPER_LIST</category>
			<filter-id>belong_to_publish_space</filter-id>
			<filter-id>not_remote_proxy</filter-id>
			<filter-id>filter@setDocumentOffline</filter-id>
			<filter-id>ABSTRACT_FILTER@INNER_PUBLICATION_FEATURE</filter-id>
		</action>

		<action id="setDocumentVersionOnlineDirect" label="command.direct.setonline"
			enabled="true" order="6" immediate="false"
			confirm="if( !confirmSetDocumentVersionOnline() ) return false;"
			link="#{operationActionBean.doOperation('setOnLine')}">
			<category>TOUTATICE_DOCUMENT_SUMMARY_CUSTOM_ACTIONS</category>
			<filter-id>belong_to_publish_space</filter-id>
			<filter-id>is_version</filter-id>
			<filter-id>filter@setDocumentOnline</filter-id>
			<filter id="filter@setDocumentVersionOnlineDirect">
				<rule grant="true">
					<condition>document.currentLifeCycleState == "approved"</condition>
				</rule>
			</filter>
			<filter-id>ABSTRACT_FILTER@INNER_PUBLICATION_FEATURE</filter-id>
		</action>

		<!-- WORKFLOWS -->
		
		<action id="EDIT_AND_SET_ONLINE_CURRENT_DOCUMENT_REQUEST" link="#{documentActions.updateNSetOnLineCurrentDocument}"
			order="1" label="command.save.and.setonline.request">
			<category>EDIT_DOCUMENT_FORM</category>
			<filter-id>is_not_thread_document</filter-id>
			<filter-id>belong_to_publish_space</filter-id>
			<filter-id>not_proxy</filter-id>
			<filter-id>not_version</filter-id>
			<filter-id>filter@updateNSetDocumentOnline</filter-id>
			<filter id="filter@EDIT_AND_SET_ONLINE_CURRENT_DOCUMENT_REQUEST">
				<rule grant="false">
					<permission>validationWorkflow_validation</permission>
				</rule>
			</filter>
			<filter-id>ABSTRACT_FILTER@INNER_PUBLICATION_FEATURE</filter-id>			
		</action>
		
		<action id="CREATE_AND_SET_ONLINE_DOCUMENT_REQUEST" link="#{documentActions.saveNSetOnLineDocument}"
			order="0" label="command.create.and.setonline.request">
			<category>CREATE_DOCUMENT_FORM</category>
			<filter-id>is_not_creating_form_specific_document</filter-id>
			<filter-id>belong_to_publish_space</filter-id>
			<filter-id>not_proxy</filter-id>
			<filter-id>not_version</filter-id>
			<filter-id>filter@updateNSetDocumentOnline</filter-id>
			<filter id="filter@CREATE_AND_SET_ONLINE_DOCUMENT_REQUEST">
				<rule grant="false">
					<permission>validationWorkflow_validation</permission>
				</rule>
			</filter>
			<filter-id>ABSTRACT_FILTER@INNER_PUBLICATION_FEATURE</filter-id>			
		</action>
		
		
		<action id="workflow_online_demand" label="Demander la mise en ligne"
			enabled="true" order="0" immediate="false"
			link="#{operationActionBean.doOperation('onlineWorkflow_start')}">
			<category>SUMMARY_PANEL_TOP</category>
			<category>SUBVIEW_UPPER_LIST</category>
			<filter-id>belong_to_publish_space</filter-id>
			<filter-id>not_version</filter-id>
			<filter-id>not_proxy</filter-id>
			<filter-id>filter@requestDocumentOnline</filter-id>
			<filter id="filter@workflow_online_demand">
				<rule grant="true">
					<condition>document.currentLifeCycleState == "project"</condition>
					<condition>document.currentLifeCycleState == "approved"</condition>
				</rule>
			</filter>
			<filter-id>ABSTRACT_FILTER@INNER_PUBLICATION_FEATURE</filter-id>
		</action>
		
		<action id="workflow_online_demand_version" label="Demander la mise en ligne"
			enabled="true" order="0" immediate="false"
			confirm="if( !confirmSetDocumentVersionOnline() ) return false;"
			link="#{operationActionBean.doOperation('onlineWorkflow_start')}">
			<category>SUMMARY_PANEL_TOP</category>
			<category>SUBVIEW_UPPER_LIST</category>
			<filter-id>belong_to_publish_space</filter-id>
			<filter-id>is_version</filter-id>
			<filter-id>filter@requestDocumentOnline</filter-id>
			<filter id="filter@workflow_online_demand_version">
				<rule grant="true">
					<condition>document.currentLifeCycleState == "approved"</condition>
				</rule>
			</filter>
			<filter-id>ABSTRACT_FILTER@INNER_PUBLICATION_FEATURE</filter-id>
		</action>

		<action id="workflow_online_cancel" label="Annuler la demande de mise en ligne"
			enabled="true" order="1" immediate="false"
			confirm="if( !confirmOnlineWorkflow_cancel() ) return false;"
			link="#{jbpmActions.cancelCurrentProcess('workflowOnlineTaskCanceled')}">
			<category>SUMMARY_PANEL_TOP</category>
			<category>SUBVIEW_UPPER_LIST</category>
			<filter-id>belong_to_publish_space</filter-id>
			<filter-id>not_proxy</filter-id>
			<filter id="filter@workflow_online_cancel">
				<rule grant="true">
					<facet>Versionable</facet>
					<permission>Write</permission>
				</rule>
				<rule grant="false">
					<type>Root</type>
				</rule>
				<rule grant="false">
					<condition>#{jbpmActions.isCancelOnlineActionAuthorized() == false}
					</condition>
				</rule>
				<rule grant="false">
					<permission>validationWorkflow_validation</permission>
				</rule>
			</filter>
			<filter-id>ABSTRACT_FILTER@INNER_PUBLICATION_FEATURE</filter-id>
		</action>

		<action id="workflow_online_accept" label="Accepter la demande de mise en ligne"
			enabled="true" order="2" immediate="false"
			link="#{operationActionBean.doOperation('onlineWorkflow_validate')}">
			<category>SUMMARY_PANEL_TOP</category>
			<category>SUBVIEW_UPPER_LIST</category>
			<filter-id>belong_to_publish_space</filter-id>
			<filter-id>not_proxy</filter-id>
			<filter id="filter@workflow_online_accept">
				<rule grant="true">
					<permission>validationWorkflow_validation</permission>
				</rule>
				<rule grant="false">
					<condition>#{jbpmActions.isValidateOnlineActionAuthorized() == false}
					</condition>
				</rule>
			</filter>
			<filter-id>ABSTRACT_FILTER@INNER_PUBLICATION_FEATURE</filter-id>
		</action>

		<action id="workflow_online_reject" label="Rejeter la demande de mise en ligne"
			enabled="true" order="3" immediate="false"
			link="#{operationActionBean.doOperation('onlineWorkflow_rejected')}">
			<category>SUMMARY_PANEL_TOP</category>
			<category>SUBVIEW_UPPER_LIST</category>
			<filter-id>belong_to_publish_space</filter-id>
			<filter-id>not_proxy</filter-id>
			<filter id="filter@workflow_online_reject">
				<rule grant="true">
					<permission>validationWorkflow_validation</permission>
				</rule>
				<rule grant="false">
					<condition>#{jbpmActions.isRejectOnlineActionAuthorized() == false}
					</condition>
				</rule>
			</filter>
			<filter-id>ABSTRACT_FILTER@INNER_PUBLICATION_FEATURE</filter-id>
		</action>

		<action id="seeOnlineDocumentVersion" label="toutatice.label.see.nuxeo.online.version"
			enabled="true" order="128" immediate="false"
			link="#{documentActions.viewOnlineVersion()}">
			<category>SUMMARY_PANEL_TOP</category>
			<filter-id>belong_to_publish_space</filter-id>
			<filter id="filter@seeOnlineDocumentVersionFromResumeView">
				<rule grant="true">
					<condition>#{documentActions.isSeeOnlineDocumentVersionActionAuthorized() == true}</condition>
				</rule>
			</filter>
			<filter-id>not_proxy</filter-id>
			<filter-id>ABSTRACT_FILTER@INNER_PUBLICATION_FEATURE</filter-id>
		</action>

		<action id="seeLiveDocumentVersion" label="toutatice.label.see.nuxeo.work.version"
			enabled="true" order="129" immediate="false"
			link="#{documentActions.viewLiveVersion()}">
			<category>SUMMARY_PANEL_TOP</category>
			<filter id="filter@seeLiveDocumentVersion">
				<rule grant="true">
					<condition>#{documentActions.isSeeLiveDocumentVersionActionAuthorized() == true}</condition>
				</rule>
			</filter>
			<filter-id>is_either_version_or_proxy</filter-id>
		</action>

		<!-- Cette action appartient à une catégorie "virtuelle" car elle ne sera 
			jamais présentée à l'IHM. Son rôle est de pouvoir présenter de façon conditionnelle 
			les actions "PUBLISH/UNPUBLISH_DOCUMENTS_SELECTION" (mettre en ligne / hors 
			ligne) en fonction du critère "appartient à un espace de publication". (voir 
			implémentation dans ToutaticeWebActionBean::getUnfiltredActionsList()) -->
		<action id="VIRTUAL_ACTION_VIEW_IN_PUBLISH_SPACE_ONLY" enabled="true"
			icon="">
			<category>VIRTUAL_CATEGORY</category>
			<filter-id>belong_to_publish_space</filter-id>
			<filter-id>ABSTRACT_FILTER@INNER_PUBLICATION_FEATURE</filter-id>
		</action>

		<!-- Vue 'Contenu' (d'un Folderish): mise en ligne d'un élément sélectionné -->
		<action
			id="PUBLISH_DOCUMENTS_SELECTION@VIRTUAL_ACTION_VIEW_IN_PUBLISH_SPACE_ONLY"
			link="#{documentActions.publishDocumentSelection}" enabled="true"
			label="command.direct.setonline" icon="">
			<category>CURRENT_SELECTION_LIST</category>
			<filter-id>canPublishSelection</filter-id>
		</action>

		<!-- Vue 'Contenu' (d'un Folderish): mise hors ligne d'un élément sélectionné -->
		<action
			id="UNPUBLISH_DOCUMENTS_SELECTION@VIRTUAL_ACTION_VIEW_IN_PUBLISH_SPACE_ONLY"
			link="#{documentActions.unPublishDocumentSelection}" enabled="true"
			label="command.direct.setoffline" icon="">
			<category>CURRENT_SELECTION_LIST</category>
			<filter-id>canUnPublishSelection</filter-id>
		</action>

		<!-- Ajout de la version et du status de publication à côté du titre du 
			document -->
		<!-- NOTE: Restreint pour l'instant aux espaces de publication -->
		<action id="EXTENDED_TITLE" enabled="true" type="widget">
			<category>DOCUMENT_HEADER_ACTIONS_LIST</category>
			<properties>
				<property name="widgetName">extended_title</property>
			</properties>
			<filter-id>belong_to_publish_space</filter-id>
			<filter-id>ABSTRACT_FILTER@INNER_PUBLICATION_FEATURE</filter-id>
		</action>

	</extension>

</component>