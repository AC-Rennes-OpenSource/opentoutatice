<div xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:nxu="http://nuxeo.org/nxweb/util"
	xmlns:nxl="http://nuxeo.org/nxforms/layout"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:a4j="https://ajax4jsf.dev.java.net/ajax"
	xmlns:nxh="http://nuxeo.org/nxweb/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:c="http://java.sun.com/jstl/core">

	<script type="text/javascript" src="#{baseURL}scripts/contextKeeper.js"></script>
	<script type="text/javascript">
		document.NXContextKeeper = new InputContextKeeper('images_list');
	</script>

	<script type="text/javascript">
		function removeUploadedFile(deleteEntry)
		{
			 if(null!=deleteEntry)
			 {
				Seam.Component.getInstance('ImageManagerActions').removeUploadedFile(deleteEntry.fileName);
			 } else {
				Seam.Component.getInstance('ImageManagerActions').removeAllUploadedFile();
			 }
		}
	</script>

	<script type="text/javascript">
	
	  function popupSearch(createFormId, url) {
	    popup = window.open(url, '_blank', 'toolbar=0, scrollbars=1, location=0, statusbar=0, menubar=0, resizable=1, dependent=1, width=712, height=480');
	    if(!popup.opener) {
	      popup.opener = window;
	    }
	    return false;
	  }
	
	  function selectObjectType(index) {
	    document.getElementsByName('createForm:objectType')[index].checked = true;
	  }
	
	  function showPopUpSearch() {
	    // hide all trees
	    hideAllRelationPopUps();
	
	    var popUp = jQuery("#imageSearchPopUp");
	    popUp.css('top', 0.1 * getDocumentHeight() + getScrollTop());
	    popUp.css('left', 0.15 * getDocumentWidth());
	
	    var popUpheader = jQuery("#closePopUpHeader");
	
	    var content = jQuery("#popUpContent");
	    content.css('height', popUp.height() - popUpheader.height() - 40);
	
	    popUp.show();
	  }
	
	  function hideAllRelationPopUps() {
	    jQuery('.imageSearchPopUp').each(function () {
	      jQuery(this).hide();
	    });
	  }
	
	  function hidePopUp() {
	    jQuery("#imageSearchPopUp").hide();
	  }
	
	  function getDocumentHeight() {
	    return jQuery(document).height();
	  }
	
	  function getDocumentWidth() {
	    return jQuery(document).width();
	  }
	
	  function getScrollTop() {
	    var scrollTop  = document.body.scrollTop  || document.documentElement.scrollTop;
	    return scrollTop;
	  }
	
	  jQuery(document).keydown(function(event) {
	    // escape
	    if (event.keyCode == '27') {
	      hideAllRelationPopUps();
	      event.preventDefault();
	    }
	  });
	
	  jQuery(document).click(function(event) {
	    var element = jQuery(event.target);
	    if (!(element.is('.imageSearchPopUp') || element.parents().is('.imageSearchPopUp')) &amp;&amp; !(element.is('.labelTool') || element.parents().is('.labelTool'))) {
	      hideAllRelationPopUps();
	    }
	  });
	</script>

	<h:form enctype="multipart/form-data" id="document_images_edit"
		rendered="#{currentDocument.hasSchema('toutatice')}"
		disableDoubleClickShield="true">

		<div>

			<table>
				<tr>
					<td class="toutatice_image_tab_cell_download">
						<h3>
							<h:outputLabel
								value="#{messages['toutatice.label.upload.images.download']}" />
						</h3> <rich:fileUpload id="images_upload"
							uploadData="#{ImageManagerActions.uploadedFiles}"
							listHeight="150" listWidth="500" maxFilesQuantity="5"
							locale="#{localeSelector.localeString}" immediateUpload="true">
							<a4j:support onsubmit="removeUploadedFile(event.memo.entry);"
								event="onclear" />
						</rich:fileUpload>

						<p class="buttonsGadget">
							<h:commandButton type="submit" immediate="true"
								value="#{messages['toutatice.command.add.images']}"
								class="button"
								action="#{ImageManagerActions.validateMultiplesUpload(currentDocument)}" />
						</p>
					</td>
					<td class="toutatice_image_tab_cell_search">
						<h3>
							<h:outputLabel
								value="#{messages['toutatice.label.upload.images.search']}" />
						</h3> <nxu:set var="actions"
							value="#{webActions.getActionsList('TOUTATICE_IMAGES_SEARCH_FROM_NUXEO')}"
							cache="true">
							<c:forEach var="action" items="#{actions}" varStatus="status">
								<ui:decorate
									template="/incl/action/generic_action_template.xhtml">
									<ui:param name="mode" value="view" />
									<ui:param name="useButton" value="true" />
								</ui:decorate>
							</c:forEach>
						</nxu:set>
					</td>
				</tr>
			</table>

		</div>

		<div id="images_list">
			<a4j:region renderRegionOnly="true" id="images_region">

				<a4j:outputPanel ajaxRendered="true">

					<h3>Liste des images jointes</h3>

					<table class="dataList dataListAlign">
						<thead>
							<tr>
								<th></th>
								<th>Aper√ßu</th>
								<th>Titre</th>
								<th>Action(s)</th>
							</tr>
						</thead>
						<tbody>

							<nxu:inputList id="images_input"
								value="#{currentDocument.toutatice.images}" model="model">
								<tr>
									<td><a4j:commandLink id="images_delete" immediate="true"
											onclick="document.NXContextKeeper.removeFromKeeper(#{model.rowIndex});"
											oncomplete="document.NXContextKeeper.onReturnAnswer();"
											actionListener="#{ImageManagerActions.performAction}"
											reRender="images_input" bypassUpdates="true">
											<h:graphicImage value="/icons/action_tag_delete.png" />
											<f:param name="index" value="#{model.rowIndex}" />
										</a4j:commandLink></td>
									<td><h:graphicImage
											value="#{nxd:complexFileUrl('downloadFile', currentDocument, 'toutatice:images', model.rowIndex, 'file', currentDocument.toutatice.images[model.rowIndex].filename)}"
											height="50px" width="50px" /></td>
									<td><nxh:outputLink
											value="#{nxd:complexFileUrl('downloadFile', currentDocument, 'toutatice:images', model.rowIndex, 'file', currentDocument.toutatice.images[model.rowIndex].filename)}">
											<nxh:outputText
												value="#{currentDocument.toutatice.images[model.rowIndex].filename}" />
										</nxh:outputLink></td>
									<td><nxu:set var="actions"
											value="#{webActions.getActionsList('TOUTATICE_IMAGES_TAB_CREATE')}"
											cache="true">
											<c:forEach var="action" items="#{actions}" varStatus="status">
												<ui:decorate
													template="/incl/action/generic_action_template.xhtml">
													<ui:param name="mode" value="view" />
													<ui:param name="useButton" value="true" />
													<ui:param name="hideIcon" value="true" />
													<ui:param name="useAjaxForm" value="true" />
													<ui:define name="before_action_trigger"><f:param name="index" value="#{model.rowIndex}" /></ui:define>
												</ui:decorate>
											</c:forEach>
										</nxu:set></td>
								</tr>
							</nxu:inputList>
						</tbody>
					</table>

					<h:message id="images_message" styleClass="errorMessage"
						for="images_input" />

				</a4j:outputPanel>
			</a4j:region>
		</div>

	</h:form>

</div>