<?xml version="1.0"?>

<component name="toutatice.ecm.plateform.automation.chains">

	<extension target="org.nuxeo.ecm.core.operation.OperationServiceComponent"
		point="chains">

		<chain id="setOnLine">
			<operation id="Context.FetchDocument" />
			<operation id="Document.SetOnLineOperation" />
			<operation id="Seam.AddInfoMessage">
				<param type="string" name="message">expr:Le document en version
					@{Document.versionLabel} est en ligne
				</param>
			</operation>
		</chain>

		<chain id="setOffLine">
			<operation id="Context.FetchDocument" />
			<operation id="Document.RemovePublishedVersions">
				<param type="document" name="target">expr:Document.parent.doc</param>
			</operation>
			<operation id="Audit.Log">
				<param type="string" name="event">Mise hors ligne</param>
				<param type="string" name="category">Automation</param>
			</operation>
		</chain>

		<chain id="setOffLineOne">
			<operation id="Context.FetchDocument" />
			<operation id="Context.RunDocumentOperation">
				<param type="string" name="id">setOffLine</param>
				<param type="boolean" name="isolate">false</param>
			</operation>
			<operation id="Seam.Refresh" />
			<operation id="Seam.NavigateTo">
				<param type="string" name="view">view_documents</param>
			</operation>
			<operation id="Seam.AddInfoMessage">
				<param type="string" name="message">Le document est hors ligne</param>
			</operation>
		</chain>


		<chain id="setOffLineSelection">
			<operation id="Context.FetchDocument" />
			<operation id="Context.RunDocumentOperation">
				<param type="string" name="id">setOffLine</param>
				<param type="boolean" name="isolate">false</param>
			</operation>
			<operation id="Seam.AddInfoMessage">
				<param type="string" name="message">La sélection de documents est hors
					ligne
				</param>
			</operation>
		</chain>

		<chain id="onlineWorkflow_start">
			<operation id="Context.FetchDocument" />
			<operation id="Document.GetUsersAndGroups">
				<param type="string" name="permission">validationWorkflow_validation
				</param>
				<param type="string" name="variable name">assignees</param>
				<param type="boolean" name="ignore groups">false</param>
				<param type="boolean" name="prefix identifiers">true</param>
				<param type="boolean" name="resolve groups">false</param>
			</operation>
			<operation id="Workflow.CreateProcess">
				<param type="string" name="task name">choose-participant</param>
				<param type="string" name="following state">no_transition</param>
				<param type="string" name="workflow type">acaren_online_approbation</param>
				<param type="string" name="actors">assignees</param>
				<param type="string" name="directive">workflowDirectiveValidation</param>
				<param type="string" name="right">Read</param>
			</operation>
			<operation id="Notification.SendEvent">
				<param type="string" name="name">workflowNewProcessStarted</param>
			</operation>
			<operation id="Seam.AddInfoMessage">
				<param type="string" name="message">La demande de mise en ligne a
					démarré.
				</param>
			</operation>
			<operation id="Notification.SendTaskNotification">
				<param type="string" name="event">workflowOnlineTaskAssigned</param>
				<param type="string" name="actors">assignees</param>
			</operation>
		</chain>

		<chain id="onlineWorkflow_validate">
			<operation id="Context.FetchDocument" />
			<operation id="Workflow.OperateProcess">
				<param type="string" name="task name">validate-online</param>
				<param type="string" name="transition">validate_online</param>
				<param type="string" name="event">workflowOnlineTaskApproved</param>
			</operation>
			<operation id="Context.RunOperation">
				<param type="string" name="id">setOnLine</param>
				<param type="boolean" name="isolate">false</param>
			</operation>
			<operation id="Notification.SendSeamEvent">
				<param type="string" name="name">workflowTaskCompleted</param>
			</operation>
			<operation id="Notification.SendSeamEvent">
				<param type="string" name="name">documentChanged</param>
			</operation>
			<operation id="Seam.AddInfoMessage">
				<param type="string" name="message">Le document est mis en ligne</param>
			</operation>
		</chain>

		<chain id="onlineWorkflow_rejected">
			<operation id="Context.FetchDocument" />
			<operation id="Workflow.OperateProcess">
				<param type="string" name="task name">validate-online</param>
				<param type="string" name="transition">reject_online</param>
				<param type="string" name="event">workflowOnlineTaskRejected</param>
			</operation>
			<operation id="Audit.Log">
				<param type="string" name="event">Rejet de la demande de mise en ligne
				</param>
				<param type="string" name="category">Automation</param>
			</operation>
			<operation id="Notification.SendSeamEvent">
				<param type="string" name="name">workflowTaskRejected</param>
			</operation>
			<operation id="Notification.SendSeamEvent">
				<param type="string" name="name">documentChanged</param>
			</operation>
			<operation id="Seam.AddInfoMessage">
				<param type="string" name="message">La demande est rejetée</param>
			</operation>
		</chain>

		<chain id="createOrMoveOp">
			<operation id="Context.FetchDocument" />
			<operation id="Document.SetSpaceID" />
		</chain>

		<chain id="vignette-resizing">
			<operation id="Context.FetchDocument" />
			<operation id="ImageResize.Operation">
				<param type="int" name="img_heidth">100</param>
				<param type="int" name="img_width">100</param>
				<param type="string" name="xpath_img_in">ttc:vignette</param>
				<param type="string" name="xpath_img_out">ttc:vignette</param>
				<param type="boolean" name="enlarge">true</param>
			</operation>
		</chain>

		<chain id="qr-add-op">
			<operation id="Context.FetchDocument" />
			<operation id="Seam.CreateDocumentForm">
				<param type="string" name="type">Question</param>
			</operation>
		</chain>
		
		<chain id="question-update">
			<operation id="Context.FetchDocument" />
			<operation id="TextExtraction.Operation">
				<param type="int" name="nb_chars_out">300</param>
				<param type="string" name="xpath_in">note:note</param>
				<param type="string" name="xpath_out">dc:description</param>
				<param type="string" name="format_in">html</param>
				<param type="boolean" name="override">true</param>
			</operation>
		</chain>

	</extension>

</component>