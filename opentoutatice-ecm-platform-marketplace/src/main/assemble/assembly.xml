<project name="open-toutatice-marketplace" default="build" xmlns:nx="urn:nuxeo-build" xmlns:artifact="urn:nuxeo-artifact">
	<taskdef resource="org/nuxeo/build/antlib.xml" uri="urn:nuxeo-build" />
	<taskdef resource="org/nuxeo/build/artifact/antlib.xml" uri="urn:nuxeo-artifact" />
	<taskdef resource="net/sf/antcontrib/antlib.xml" />

	<target name="build" description="Build the Nuxeo open toutatice platform Marketplace package">
		<property name="outdir" value="${maven.project.build.directory}" />
		<mkdir dir="${outdir}" />

		<!-- Build the dependency tree, including the "test" scope, resolving artifacts 
			if needed -->
		<artifact:nuxeo-expand includeTestScope="true" groupPrefixes="org.nuxeo" />

		<!-- Create specific optional files for use by Nuxeo SDK -->
		<artifact:print output="${outdir}/artifacts-opentoutatice.properties" mode="sdk" />
		<artifact:print output="${outdir}/test-artifacts-opentoutatice.properties" mode="sdk" scopes="test" />

		<!-- Output the dependency tree for debugging purpose -->
		<artifact:print output="${outdir}/dependency-tree.log" />
		<tstamp />

		<delete failonerror="false" dir="${outdir}/marketplace" />
		<mkdir dir="${outdir}/marketplace" />

		<!-- Copy of MP resources -->
		<copy todir="${outdir}/marketplace">
			<fileset dir="src/main/resources" />
			<filterset>
				<filter token="VERSION" value="${maven.project.version}" />
				<filter token="NUXEO_VERSION" value="${nuxeo.version}" />
				<filter token="DISTRIB_VERSION" value="${nuxeo.distribution.version}" />
				<filter token="NUXEO_JSF_UI_VERSION" value="${nuxeo.jsf.ui.version}" />
				<filter token="NUXEO_DAM_VERSION" value="${nuxeo.dam.version}" />
				<filter token="NUXEO_BLOGS_SITES_VERSION" value="${nuxeo.blogs.sites.version}" />
			</filterset>
		</copy>

		<!-- Copy of Opentoutatice plugins and dependencies -->
		<copy todir="${outdir}/marketplace/install/plugins" overwrite="true">
			<artifact:set>
				<includes>
					<artifact groupId="opentoutatice-ecm.platform*" />
					<artifact groupId="opentoutatice.ui*" />
				</includes>
				<excludes>
					<artifact scope="test" />
					<artifact scope="provided" />
					<artifact type="pom" />
				</excludes>
			</artifact:set>
			<artifact:resolveFile key="org.nuxeo.ecm.platform:nuxeo-platform-login-portal-sso:${nuxeo.version}:jar::" />
		</copy>

		<!-- Copy of Opentoutatice libs -->
		<copy todir="${outdir}/marketplace/install/lib" overwrite="true">
			<artifact:resolveFile key="net.sf.json-lib:json-lib:${net.sf.json.version}:jar:jdk15:" />
			<artifact:resolveFile key="org.jsoup:jsoup:${org.jsoup.version}:jar::" />
			<artifact:set>
				<includes>
					<artifact groupId="org.richfaces" />
				</includes>
			</artifact:set>
		</copy>

		<zip destfile="${outdir}/${maven.project.artifactId}-${maven.project.version}.zip" basedir="${outdir}/marketplace" />
		<artifact:attach file="${outdir}/${maven.project.artifactId}-${maven.project.version}.zip" type="zip" />

	</target>

</project>
