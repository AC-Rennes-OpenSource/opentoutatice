<process-definition name="acaren_online_approbation">
	<swimlane name="initiator" />

	<start-state>
		<task swimlane='initiator' name="start" />
		<transition to='choose participants online node' />
	</start-state>

	<task-node name="choose participants online node">
		<task name="choose-participant" swimlane="initiator" />
		<transition to="condition on participants" />
	</task-node>

	<!-- add rights -->
	<decision name="condition on participants">
		<event type="node-enter">
			<script>
				<variable name="participant" />
				<expression><![CDATA[executionContext.setVariable("previousActorId", (participant == null ? Collections.singletonList(executionContext.getJbpmContext().getActorId()) : participant.actors))]]></expression>
			</script>
		</event>
		<transition to="setup rights">
			<script>
				<variable name="participants" />
				<variable name="participant" access="write" />
				<expression><![CDATA[participant = participants.remove(0)]]></expression>
			</script>
		</transition>
		<transition condition="#{empty participants}" to="do follow transition" />
	</decision>

	<node name="setup rights">
		<action class="org.nuxeo.ecm.platform.jbpm.core.helper.AddRightsActionHandler">
			<list>participants</list>
		</action>
		<transition to="validate online node" />
	</node>

	<task-node name="validate online node">
		<task name="validate-online">
			<event type="task-create">
				<action	class="org.nuxeo.ecm.platform.jbpm.core.helper.TaskNotificationHandler" />
			</event>
			<controller	class="org.nuxeo.ecm.platform.jbpm.core.node.VirtualTaskInstanceController" />
			<assignment pooled-actors="#{participant.actors}" />
		</task>
		<transition name="validate_online" to="condition on participants" />
		<transition name="reject_online" to="condition on participants"> <!-- supprimer l'Ã©tat de "validation du rejet" par l'initiateur de la demande - Mantis #3243 -->
			<script>
				<expression><![CDATA[executionContext.setVariable("rejected", true)]]></expression>
			</script>
		</transition>
	</task-node>
			
	<!-- Added the decision node "do follow transition" - Mantis #2631 -->
	<decision name="do follow transition">
		<transition to="end" condition="#{contextInstance.variables['rejected']}" />
		<transition to="follow transition" condition="#{!contextInstance.variables['rejected']}" />
	</decision>

	<node name="follow transition">
		<action	class="fr.toutatice.ecm.platform.core.helper.ToutaticeLifecycleTransitionActionHandler" />
		<transition to="end" />
	</node>
	<end-state name="end">
		<event type="node-enter">
			<action	class="org.nuxeo.ecm.platform.jbpm.core.helper.RemoveRightsActionHandler" />
			<action	class="org.nuxeo.ecm.platform.jbpm.core.helper.SendEventActionHandler">
				<eventName>workflowProcessEnded</eventName>
				<recipients>initiator</recipients>
			</action>
		</event>
	</end-state>
</process-definition>