<!-- Mantis #4347 en attente de correction (http://www.toutatice.fr/mantis2/view.php?id=4347) -->
<div xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:a4j="https://ajax4jsf.dev.java.net/ajax"
	xmlns:nxu="http://nuxeo.org/nxweb/util"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:rich="http://richfaces.org/rich">

	<c:if test="#{nxl:isLikeViewMode(widget.mode) and not empty field}">
		<nxu:set var="selectedFlavor" value="#{themeActions.getFlavor(field)}"
			cache="true">

			<c:if test="#{not empty selectedFlavor.palettePreview.colors}">
				<nxu:set var="colorValue"
					value="#{nxu:test(not empty selectedFlavor.palettePreview.colors[0], selectedFlavor.palettePreview.colors[0], '#fff')}">
					<div style="background-color:#{colorValue};width:20px;height:20px"/>
				</nxu:set>
			</c:if>

		</nxu:set>
	</c:if>

	<c:if test="#{widget.mode == 'edit'}">

		<a4j:region id="#{widget.id}_region" renderRegionOnly="true">
			<a4j:outputPanel id="#{widget.id}_editselect">

				<nxu:set var="defaultFlavorName"
					value="#{themeConfigurationActions.getDefaultFlavorName('toutatice/portal')}"
					cache="true">

					<nxu:set var="origSelectedFlavorName"
						value="#{nxu:test(empty field, defaultFlavorName, field)}">

						<nxu:set var="switchState"
							value="#{documentActions.initSwitchState('ttc:theme')}">

							<div class="checkDiv" id="#{widget.id}_check">

								<c:choose>
									<c:when test="#{switchState}">
										<c:set var="styleBodySelection" value="display:none;" />
										<a4j:commandLink id="#{widget.id}_btSwitchok" 
											immediate="true"
											reRender="#{widget.id}_editselect"
											actionListener="#{documentActions.setIsSwitchState('false', 'ttc:theme')}">
											<h:graphicImage url="/icons/toggle_plus.png" />
											<h:outputText value="#{messages['toutatice.action.edit.set.theme']}" />
										</a4j:commandLink>
									</c:when>
									<c:otherwise>
										<c:set var="styleBodySelection" value="" />
										<a4j:commandLink id="#{widget.id}_btSwitchok" 
											immediate="true"
											reRender="#{widget.id}_editselect"
											actionListener="#{documentActions.setIsSwitchState('true', 'ttc:theme')}">
											<h:graphicImage url="/icons/toggle_minus.png" />
											<h:outputText value="#{messages['toutatice.action.edit.unset.theme']}" />
										</a4j:commandLink>
									</c:otherwise>
								</c:choose>

							</div>

							<h:panelGrid columns="3"
								columnClasses=",flavorPreview,flavorWaiter"
								style="#{nxu:test(switchState,'display:none;','')}">

								<h:panelGroup>
									<nxu:set var="flavors"
										value="#{themeConfigurationActions.getAvailableFlavors('toutatice/portal')}"
										cache="true">
										<h:selectOneListbox id="#{widget.id}" value="#{field}"
											size="1">
											<nxu:selectItems var="flavor" value="#{flavors}"
												itemValue="#{flavor.name}"
												itemLabel="#{messages[flavor.label]}" />
											<a4j:support event="onchange" bypassUpdates="true"
												actionListener="#{selectionActions.onSelection}"
												reRender="#{widget.id}_preview"
												id="#{widget.id}_ajax_select">
												<f:param name="selectorId" value="#{widget.id}" />
												<f:param name="valueHolderId"
													value="#{widget.id}_valueHolder" />
											</a4j:support>
										</h:selectOneListbox>
									</nxu:set>
									<h:message for="#{widget.id}" id="#{widget.id}_message"
										styleClass="errorMessage" />
								</h:panelGroup>

								<nxu:valueHolder id="#{widget.id}_valueHolder"
									var="selectedFlavorName" 
									submitChanges="false">
									<a4j:outputPanel id="#{widget.id}_preview">

										<nxu:set var="selectedFlavor"
											value="#{nxu:test(empty selectedFlavorName, themeActions.getFlavor(origSelectedFlavorName), themeActions.getFlavor(selectedFlavorName))}"
											cache="true">

											<h:panelGrid columns="2">

												<c:if test="#{not empty selectedFlavor.palettePreview.colors}">
													<nxu:set var="colorValue"
														value="#{nxu:test(not empty selectedFlavor.palettePreview.colors[0], selectedFlavor.palettePreview.colors[0], '#fff')}">
														<div style="background-color:#{colorValue};width:50px;height:70px"/>
													</nxu:set>
												</c:if>

												<c:choose>
													<c:when test="#{! empty selectedFlavor.logo.previewPath}">
														<h:graphicImage value="#{selectedFlavor.logo.previewPath}"
															class="toutaticePalettePreviewLogo" />
													</c:when>
													<c:otherwise>
														<c:choose>
															<c:when test="#{! empty selectedFlavor.logo.path}">
																<h:graphicImage value="#{selectedFlavor.logo.path}"
																	class="toutaticePalettePreviewLogo" />
															</c:when>
															<c:otherwise>
	                    #{messages['label.local.configuration.theme.flavorSelection.noPreviewAvailable']}
	                  										</c:otherwise>
														</c:choose>
													</c:otherwise>
												</c:choose>

											</h:panelGrid>

										</nxu:set>
									</a4j:outputPanel>
								</nxu:valueHolder>

								<a4j:status>
									<f:facet name="start">
										<h:graphicImage value="/img/standart_waiter.gif" />
									</f:facet>
								</a4j:status>

							</h:panelGrid>

						</nxu:set>
					</nxu:set>
				</nxu:set>
			</a4j:outputPanel>
		</a4j:region>

	</c:if>

</div>